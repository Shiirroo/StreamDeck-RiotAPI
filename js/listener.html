<!DOCTYPE HTML>
<html>

<head>
    <title>Riot Games Index</title>
    <meta charset="utf-8" />
    <script src="../foundation/common.js"></script>
    <script src="../foundation/moment.js"></script>
    <script src="../foundation/jquery-3.3.1.js"></script>
    <script src="./request.js"></script>
    <script src="./leagueoflegends/summoner.js"></script>
    <script src="./leagueoflegends/main.js"></script>
    <script src="./utilis/utilts.js"></script>
</head>

<body>
    <script>

        let intervals = {};

        if ($SD) {
            const actionName = ["de.shiro.leauge.api.action", "de.shiro.tft.api.action", "de.shiro.lor.api.action", "de.shiro.valorant.api.action"];

            $SD.on("connected", function (jsonObj) {
                console.log("Connected!");
            });

            $.each(actionName, function (index) {
                $SD.on(actionName[index] + ".willAppear", function (jsonObj) {
                    if (jsonObj.payload.settings.automaticRefresh !== 0 & jsonObj.payload.settings.apiKey != undefined) {
                        updateSD(jsonObj.context, jsonObj.payload.settings, jsonObj.device, actionName[index]);
                    }
                });
                $SD.on(actionName[index] + ".sendToPlugin", function (jsonObj) {
                    $SD.api.setSettings(jsonObj.context, jsonObj.payload);
                    updateSD(jsonObj.context, jsonObj.payload, null, actionName[index]);
                });

                $SD.on(actionName[index] + ".keyUp", function (jsonObj) {
                    updateSD(jsonObj.context, jsonObj.payload.settings, jsonObj.device, actionName[index]);
                })
            });



            function listener(context, settings, device, code) {
                switch (code) {
                    case "de.shiro.leauge.api.action":
                        initiateLeaugeStatus(settings, result => getResult(result, context, device));
                        break;
                    case "de.shiro.tft.api.action":
                        break;
                    case "de.shiro.lor.api.action":
                        break;
                    case "de.shiro.valorant.api.action":
                        break;

                    default:
                        break;
                }
            }

        }

        function updateSD(context, settings, device, code) {
            if (intervals[context]) {
                let interval = intervals[context];
                clearInterval(interval);
            }
            $SD.api.setState(context, { "State": { 'state': 0 } });
            $SD.api.setTitle(context, "Updating...");
            // Initial call for the first time, then schedule for every settings.automaticRefresh time set.
            listener(context, settings, device, code)
            if (settings.automaticRefresh !== 0) {
                intervals[context] = setInterval(() => {
                    let clonedSettings = {};
                    // Just making sure we are not hurt by closure.
                    Object.assign(clonedSettings, settings);
                    listener(context, settings, device, code)
                },
                    moment.duration(settings.automaticRefresh, 'minutes').asMilliseconds());
            }
        }

        function getResult(result, context) {
            if (result.hasOwnProperty("State")) {
                $SD.api.setState(context, result.State);
            }
            if (result.hasOwnProperty("Text")) {
                $SD.api.setTitle(context, result.Text);
            }
            if (!result.hasOwnProperty("Text")) {
                $SD.api.setTitle(context, "");
            }
            if (result.hasOwnProperty("Icon")) {
                toDataURL(result.Icon,
                    function (dataUrl) {
                        $SD.api.setImage(context, dataUrl);
                    }
                );
            }
            if (!result.hasOwnProperty("Icon") && !result.hasOwnProperty("Text")) {
                $SD.api.setTitle(context, result);
            }

        }


    </script>

</body>

</html>