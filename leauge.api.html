<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>de.shiro.leauge.api</title>
    <link rel="stylesheet" href="./css/sdpi.css">
    <script src="./foundation/jquery-3.3.1.js"></script>
    <script src="./foundation/common.js"></script>
    <script src="./js/server_region.js"></script>
</head>

<body>
    <div class="sdpi-wrapper">
        <div class="sdpi-item">
            <div class="sdpi-item-label">Riot API Key</div>
            <input class="sdpi-item-value" id="apiKey" required>
        </div>
        <div class="sdpi-item" id="apiKeyValidationMessage" style="display: none">
            <details class="message caution">
                <summary>API is required. Please check the instructions to see how you can obtain it.</summary>
            </details>
        </div>
        <div class="sdpi-item">
            <div class="sdpi-item-label">Instructions</div>
            <details class="sdpi-item-value">
                <p>You can learn more about this plugin and how to obtain an API key by visiting its Github
                    page by <a href="#" onclick="openGithub()">clicking here.</a>
            </details>
        </div>
        <div class="sdpi-heading">SETTINGS</div>
        <div class="sdpi-item" id="serverCodeContainer">
            <div class="sdpi-item-label">Server</div>
            <select class="sdpi-item-value select" id="serverCode">
            </select>
        </div>
        <div class="sdpi-item" id="summonerContainer">
            <div class="sdpi-item-label">Summoners Name</div>
            <input class="sdpi-item-value" id="summonerName" required>
        </div>
        <div class="sdpi-item">
            <div class="sdpi-item-label">Mode</div>
            <select class="sdpi-item-value select" id="modus">
                <option value="1">Summoner</option>
                <option value="2">League of League Service Status</option>
                <option value="3">Summoner Ranked Solo/Duo</option>
                <option value="4">Summoner Ranked Flex</option>
                <option value="5">League of League Top Ranking</option>
                <option value="6">Spectate Game</option>
                <option value="7">Champion Mastery Points</option>

            </select>
        </div>
        <div class="sdpi-item" id="getSummoner_container">
            <div class="sdpi-item-label">Summoner</div>
            <select class="sdpi-item-value select" id="getSummoner">
                <option value="1">Summoner Level</option>
                <option value="2">Summoner Icon</option>
                <option value="3">Total Champion MasteryPoints</option>
                <option value="4">Champion MasteryPoints</option>
                <option value="5">Top 5 MasteryPoints</option>
            </select>
        </div>
        <div class="sdpi-item" id="getServiceStatus_container" style="display: none">
            <div class="sdpi-item-label">Service Status</div>
            <select class="sdpi-item-value select" id="getServiceStatus">
                <option value="1">Game</option>
                <option value="2">Store</option>
                <option value="3">Website</option>
                <option value="4">Client</option>
            </select>
        </div>
        <div class="sdpi-item" id="getRankedSolo_Duo_container" style="display: none">
            <div class="sdpi-item-label">Ranked Solo|Duo</div>
            <select class="sdpi-item-value select" id="getRankedSolo_Duo">
                <option value="1">Rank</option>
                <option value="2">LP</option>
                <option value="3">Wins</option>
                <option value="4">Losses</option>
                <option value="5">Winrate</option>
            </select>
        </div>
        <div class="sdpi-item" id="getRankedFlex_container" style="display: none">
            <div class="sdpi-item-label">Ranked Flex</div>
            <select class="sdpi-item-value select" id="getRankedFlex">
                <option value="1">Rank</option>
                <option value="2">LP</option>
                <option value="3">Wins</option>
                <option value="4">Losses</option>
                <option value="5">Winrate</option>
            </select>
        </div>
        <div class="sdpi-item" id="getTopRanking_container" style="display: none">
            <div class="sdpi-item-label">Top Ranking</div>
            <select class="sdpi-item-value select" id="getTopRanking">
                <option value="2">Ranked_Solo Rank</option>
                <option value="3">Ranked_Solo LP</option>
                <option value="4">Ranked_Solo Wins</option>
                <option value="5">Ranked_Solo losses</option>
            </select>
        </div>
        <div class="sdpi-item" id="getSpectateGame_container" style="display: none">
            <div class="sdpi-item-label">Spectate Game</div>
            <select class="sdpi-item-value select" id="getSpectateGame">
                <option value="1">Show Game</option>
            </select>
        </div>
        <div class="sdpi-item" id="getChampionMasteryPoints_container" style="display: none">
            <div class="sdpi-item-label">Champion Mastery Points</div>
            <select class="sdpi-item-value select" id="getChampionMasteryPoints">
                <option value="1">Summoner Level</option>
                <option value="2">Summoner Icon</option>
                <option value="3">Total Champion MasteryPoints</option>
                <option value="4">Champion MasteryPoints</option>
                <option value="5">Top 5 MasteryPoints</option>
            </select>
        </div>
        <div class="sdpi-item" id="championContainer" style="display: none">
            <div class="sdpi-item-label">Champion</div>
            <select class="sdpi-item-value select" id="champion">
            </select>
        </div>
        <div class="sdpi-item" id="topChampionMasteryContainer" style="display: none">
            <div class="sdpi-item-label">Place</div>
            <select class="sdpi-item-value select" id="topChampionMastery">
                <option value="0">1</option>
                <option value="1">2</option>
                <option value="2">3</option>
                <option value="3">4</option>
                <option value="4">5</option>
            </select>
        </div>
        <div class="sdpi-item" id="automaticRefreshContainer">
            <div class="sdpi-item-label">Automatic Refresh</div>
            <select class="sdpi-item-value select" id="automaticRefresh">
                <option value="0"> Not at all</option>
                <option value="1"> 1 minutes</option>
                <option value="5"> 5 minutes</option>
                <option value="10">10 minutes</option>
                <option value="30">30 minutes</option>
                <option value="60">60 minutes</option>
            </select>
        </div>
        <div class="sdpi-item">
            <button class="sdpi-item-value" id="updateButton">Update</button>
        </div>
    </div>

    <script>
        let uuid = "",
            actionName = "",
            settings = "";

        var Version,
            ChampionsList;


        if ($SD) {
            $SD.on('connected', async function (jsonObj) {
                uuid = jsonObj['uuid'];
                if (jsonObj.hasOwnProperty('actionInfo')) {
                    actionName = jsonObj.actionInfo.action;
                }
                settings = $SD.actionInfo.payload.settings;

                if (settings.apiKey) {
                    await $("#apiKey").val(settings.apiKey);
                }

                if (settings.modus) {
                    await $("#modus option[value=" + settings.modus + "]")
                        .prop("selected", "selected").change();
                }

                if (settings.summonerName) {
                    await $("#summonerName").val(settings.summonerName);
                }

                if (settings.getSummoner) {
                    await $("#getSummoner option[value=" + settings.getSummoner + "]")
                        .prop("selected", "selected").change();
                }

                if (settings.getServiceStatus) {
                    await $("#getServiceStatus option[value=" + settings.getServiceStatus + "]")
                        .prop("selected", "selected").change();
                }
                if (settings.getRankedSolo_Duo) {
                    await $("#getRankedSolo_Duo option[value=" + settings.getRankedSolo_Duo + "]")
                        .prop("selected", "selected").change();
                }
                if (settings.getRankedFlex) {
                    await $("#getRankedFlex option[value=" + settings.getRankedFlex + "]")
                        .prop("selected", "selected").change();
                }
                if (settings.getTopRanking) {
                    await $("#getTopRanking option[value=" + settings.getTopRanking + "]")
                        .prop("selected", "selected").change();
                }
                if (settings.getSpectateGame) {
                    await $("#getSpectateGame option[value=" + settings.getSpectateGame + "]")
                        .prop("selected", "selected").change();
                }

                if (settings.getChampionMasteryPoints) {
                    await $("#getChampionMasteryPoints option[value=" + settings.getChampionMasteryPoints + "]")
                        .prop("selected", "selected").change();
                }

                if (settings.automaticRefresh) {
                    await $("#automaticRefresh option[value=" + settings.automaticRefresh + "]")
                        .prop("selected", "selected").change();
                }

                if (settings.serverCode) {
                    await $('#serverCode option[value=' + settings.serverCode + ']')
                        .prop('selected', 'selected').change();
                }

                if (settings.champion) {
                    await $('#champion option[value=' + settings.champion + "-" + settings.championname + ']')
                        .prop('selected', 'selected').change();
                }

                if (settings.topChampionMastery) {
                    $('#topChampionMastery option[value=' + settings.topChampionMastery + ']')
                        .prop('selected', 'selected').change();
                }
            });
        }

        $(document).ready(async function () {

            $.each(server_region, function (index) {
                $("#serverCode").append($("<option/>")
                    .val(server_region[index].code)
                    .text(server_region[index].name));
            });


            version = await getVersion();
            ChampionsList = await getChamp(version);

            $.each(ChampionsList, function (index) {
                $("#champion").append($("<option/>")
                    .val(ChampionsList[index].key + "-" + ChampionsList[index].id)
                    .text(ChampionsList[index].id));
            });

            $("#apiKey").on("blur", function () {
                if (!$("#apiKey").val()) {
                    $("#apiKeyValidationMessage").show();
                } else {
                    $("#apiKeyValidationMessage").hide();
                }
            });
        });


        async function getVersion() {
            let url = "https://ddragon.leagueoflegends.com/api/versions.json"
            var data;
            await $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: async function (response) {
                    if (response) {
                        return data = response[0];
                    }
                },
                error: async function (jqxhr, textStatus, error) {
                    console.log("ERROR")
                },
            });
            return data;
        }

        async function getChamp(version) {
            let url = "http://ddragon.leagueoflegends.com/cdn/{version}/data/en_US/champion.json".replace("{version}", version);
            var data;
            await $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: async function (response) {
                    if (response) {
                        data = response.data;
                    }
                },
                error: async function (jqxhr, textStatus, error) {
                    console.log("ERROR")
                },
            });
            return data;
        }

        $("#modus").on("change", async function () {
            let hide = ["getSummoner_container", "getServiceStatus_container", "getRankedSolo_Duo_container", "getRankedFlex_container", "getTopRanking_container", "getSpectateGame_container", "championContainer", "topChampionMasteryContainer", "getChampionMasteryPoints_container"],
                show;
            switch (parseInt($("#modus option:selected").val())) {
                case 1:
                    show = ["getSummoner_container"]
                    if (parseInt($("#getSummoner option:selected").val()) === 4) {
                        show.push("championContainer")
                    }
                    else if (parseInt($("#getSummoner option:selected").val()) === 5) {
                        show.push("topChampionMasteryContainer")
                    }
                    break;
                case 2:
                    show = ["getServiceStatus_container"]
                    break;
                case 3:
                    show = ["getRankedSolo_Duo_container"]
                    break;
                case 4:
                    show = ["getRankedFlex_container"]
                    break;
                case 5:
                    show = ["getSpectateGame_container"]
                    break;
                case 6:
                    show = ["getSpectateGame_container"]
                    break;
                case 7:
                    show = ["getChampionMasteryPoints_container"]
                    break;
                default:
                    break;
            }
            await doHideShow(hide, show)
        });


        $("#getSummoner").on("change", async function () {
            if (parseInt($("#modus option:selected").val()) === 1) {
                var hide = [],
                    show;
                switch (parseInt($("#getSummoner option:selected").val())) {
                    case 4:
                        hide = ["topChampionMasteryContainer"]
                        show = ["championContainer"];
                        break;
                    case 5:
                        hide = ["championContainer"]
                        show = ["topChampionMasteryContainer"];
                        break;

                    default:
                        hide.push("topChampionMasteryContainer", "championContainer")
                        break;
                }
                doHideShow(hide, show)
            }
        });



        async function doHideShow(hide, show) {
            console.log(hide + " " + show)
            if (hide !== undefined) await hide.forEach(element => {
                $("#" + element).hide();
            });
            if (show !== undefined) await show.forEach(element => {
                $("#" + element).show();
            });


        }



        $("#updateButton").click(function () {
            // Sending the saved settings to the plugin from property inspector.
            let apiKey = $("#apiKey").val();
            let serverCode = $("#serverCode option:selected").val();
            let summonerName = $("#summonerName").val();
            let getRankedSolo_Duo = parseInt($("#getRankedSolo_Duo option:selected").val());
            let modus = parseInt($("#modus option:selected").val());
            let getServiceStatus = parseInt($("#getServiceStatus option:selected").val());
            let getRankedFlex = parseInt($("#getRankedFlex option:selected").val());
            let getTopRanking = parseInt($("#getTopRanking option:selected").val());
            let getSpectateGame = parseInt($("#getSpectateGame option:selected").val());
            let getChampionMasteryPoints = parseInt($("#getChampionMasteryPoints option:selected").val());
            let champion = $("#champion option:selected").val().split("-")[0];
            let championname = $("#champion option:selected").val().split("-")[1];
            let topChampionMastery = parseInt($("#topChampionMastery option:selected").val());
            let getSummoner = parseInt($("#getSummoner option:selected").val());
            let automaticRefresh = parseInt($("#automaticRefresh option:selected").val());
            console.log(automaticRefresh)

            if (!$("#apiKey").val()) {
                return;
            }

            if ($SD && $SD.connection) {
                let payload = {};
                payload.automaticRefresh = automaticRefresh;
                payload.apiKey = apiKey;
                payload.summonerName = summonerName;
                payload.getSummoner = getSummoner;
                payload.modus = modus;
                payload.champion = champion;
                payload.version = version;
                payload.ChampionsList = ChampionsList;
                payload.topChampionMastery = topChampionMastery;
                payload.championname = championname;
                payload.getServiceStatus = getServiceStatus;
                payload.getRankedFlex = getRankedFlex;
                payload.getTopRanking = getTopRanking;
                payload.getSpectateGame = getSpectateGame;
                payload.getChampionMasteryPoints = getChampionMasteryPoints;
                payload.serverCode = serverCode;
                payload.getRankedSolo_Duo = getRankedSolo_Duo;
                $SD.api.sendToPlugin(uuid, actionName, payload);
            }
        });

        function openGithub() {
            $SD.api.openUrl($SD.actionInfo.context, "https://github.com/tarikguney/weather-plugin-for-elgato-streamdeck")
        }

    </script>

</body>

</html>